<!DOCTYPE html>
<html>
<head>
  <title>Color Match Rush</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #9059d6; }
    #start { font-size: 2rem; padding: 1.3em 2em; border-radius: 12px; border: none; margin: 2em 0 1.5em 0; cursor: pointer; background: #fc0; color: #421e5a;}
    #game { display: none; margin-top: 20px; flex-direction: column; align-items:center;}
    #score { font-size: 2rem; color: #fc0; font-weight:bold; margin-bottom: 16px; }
    .color-btn { width: 80px; height: 80px; font-size: 32px; border-radius: 50%; border: none; margin: 10px; cursor: pointer; }
    #msg { font-size:18px; color:#fff; min-height:30px; margin-top:20px;}
  </style>
</head>
<body>
  <h1 style="color:white; font-weight:900; margin-top:-30px;">Color Match Rush</h1>
  <button id="start">PAY & START</button>
  <div id="game">
    <div id="score">Score: <span id="scoreval">0</span></div>
    <div id="target"></div>
    <div>
      <button class="color-btn" style="background:#e74c3c" data-c="red">üî¥</button>
      <button class="color-btn" style="background:#3498db" data-c="blue">üîµ</button>
      <button class="color-btn" style="background:#2ecc71" data-c="green">üü¢</button>
      <button class="color-btn" style="background:#ffd700" data-c="yellow">üü°</button>
    </div>
    <div id="msg"></div>
  </div>

  <script type="module">
    // Dismiss Farcaster splash ASAP (mobile)
    let readyOnce = false;
    async function farcasterReady() {
      try {
        if(readyOnce) return;
        readyOnce = true;
        const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk@latest');
        await sdk.actions.ready();
        window.farcasterSDK = sdk;
      } catch(e){}
    }
    farcasterReady();

    // Payment logic (Farcaster and MetaMask, Base chain, 0.00001 ETH)
    async function payToPlay() {
      const TO = "0xeEa2d9A4B21B23443bF01C1ccD31632107eD8Ec1";
      const AMOUNT = "0x9184e72a000";
      const CHAIN = "0x2105";
      try {
        if(window.farcasterSDK && window.farcasterSDK.wallet && window.farcasterSDK.wallet.getEthereumProvider) {
          const provider = await window.farcasterSDK.wallet.getEthereumProvider();
          const accounts = await provider.request({method:"eth_requestAccounts"});
          await provider.request({method:'eth_sendTransaction',params:[{from:accounts[0],to:TO,value:AMOUNT,chainId:CHAIN}]});
          return true;
        }
      } catch(e){}
      if(window.ethereum) {
        const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
        await window.ethereum.request({method:"eth_sendTransaction",params:[{from:accounts[0],to:TO,value:AMOUNT,chainId:CHAIN}]});
        return true;
      }
      alert("No payment method found. Please use Warpcast app or install MetaMask.");
      return false;
    }

    // Game logic
    let score = 0, playing = false, colors=["red","blue","green","yellow"], timer;
    let targetColor = "";
    function nextRound() {
      targetColor = colors[Math.floor(Math.random()*4)];
      document.getElementById('target').innerHTML = `<span style="font-size:2.2rem">Match: <b style="color:${targetColor}">${targetColor.toUpperCase()}</b></span>`;
      document.getElementById('msg').textContent="";
      // End game after 10 rounds
      if(score>=10){
        document.getElementById('msg').textContent="üèÅ Game over! You scored "+score+"!";
        playing = false;
        document.getElementById('target').style.display = "none";
        return;
      }
      playing = true;
    }
    document.querySelectorAll(".color-btn").forEach(btn=>{
      btn.onclick = function() {
        if(!playing) return;
        if(this.getAttribute('data-c')===targetColor) {
          score += 1;
          document.getElementById('scoreval').textContent = score;
          nextRound();
        } else {
          document.getElementById('msg').textContent="‚ùå Wrong! Try again.";
        }
      };
    });

    document.getElementById("start").onclick = async function() {
      this.disabled = true; this.textContent = "Processing payment...";
      let paid = false;
      try { paid = await payToPlay(); } catch(e){}
      if(paid) {
        this.style.display = "none";
        document.getElementById("game").style.display = "flex";
        score = 0;
        document.getElementById('scoreval').textContent = score;
        document.getElementById('target').style.display = "block";
        nextRound();
      } else {
        this.disabled = false; this.textContent = "PAY & START";
      }
    };
  </script>
</body>
</html>
